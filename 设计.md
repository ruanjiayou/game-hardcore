# é¡¹ç›®è®¾è®¡

## æµç¨‹å›¾

### ç”¨æˆ·ç™»é™†æµç¨‹
```mermaid
flowchart TD
    A["ğŸŒ å‰ç«¯è®¿é—®"] -->|è¾“å…¥ç”¨æˆ·åå¯†ç | B["ç™»é™†é¡µé¢"]
    B --> C{ç™»é™†æ–¹å¼?}
    
    C -->|æ­£å¼ç™»é™†| D["POST /api/auth/login"]
    C -->|æ¸¸å®¢è¿›å…¥| E["ç”Ÿæˆä¸´æ—¶ userId<br/>guest_xxxxx"]
    
    D --> F["MongoDBéªŒè¯ç”¨æˆ·"]
    F -->|éªŒè¯æˆåŠŸ| G["è¿”å› userId"]
    F -->|éªŒè¯å¤±è´¥| H["ç™»é™†å¤±è´¥"]
    
    G --> I["ä¿å­˜ userId åˆ° localStorage"]
    E --> I
    
    I --> J["è¿æ¥ WebSocket<br/>auth: { userId }"]
    
    J --> K["åç«¯è®¤è¯ä¸­é—´ä»¶"]
    K -->|éªŒè¯ userId| L["socket.userId = userId"]
    
    L --> M["è¿›å…¥æ¸¸æˆå¤§å…<br/>æ˜¾ç¤ºæ¸¸æˆåˆ—è¡¨"]
    M --> N["æ˜¾ç¤ºç”¨æˆ·åŸºç¡€ä¿¡æ¯<br/>ç”¨æˆ·åã€å¤´åƒ"]
    
    style A fill:#e1f5ff,color:#000
    style M fill:#c8e6c9,color:#000
    style H fill:#ffcdd2,color:#000
```

### åˆ›å»ºç©å®¶æµç¨‹
```mermaid
flowchart TD
    A["å¤§å…é¡µé¢<br/>é€‰æ‹©æŸä¸ªæ¸¸æˆ"] --> B["emit: lobby:select-game"]
    
    B --> C["åç«¯æŸ¥è¯¢è¯¥æ¸¸æˆä¿¡æ¯"]
    C --> D["emit: game:selected"]
    
    D --> E["å‰ç«¯æ˜¾ç¤ºæ¸¸æˆè¯¦æƒ…"]
    E --> F{"ç©å®¶<br/>æ˜¯å¦å­˜åœ¨?"}
    
    F -->|é¦–æ¬¡è¿›å…¥è¯¥æ¸¸æˆ| G["åˆ›å»º Player<br/>MongoDB"]
    F -->|ä¹‹å‰ç©è¿‡| H["è¿”å›ç°æœ‰ Player"]
    
    G --> I["åˆå§‹åŒ–ç©å®¶æ•°æ®<br/>level: 1<br/>exp: 0<br/>rating: 1000<br/>total_games: 0"]
    H --> I
    
    I --> J["ç¼“å­˜å½“å‰<br/>selectedGameId"]
    
    J --> K["æ˜¾ç¤ºè¯¥æ¸¸æˆæˆ¿é—´åˆ—è¡¨"]
    K --> L["æ˜¾ç¤ºæ’è¡Œæ¦œ<br/>è¯¥æ¸¸æˆçš„æ’å"]
    
    style G fill:#fff9c4,color:#000
    style I fill:#c8e6c9,color:#000
```

### æˆ¿é—´åˆ›å»ºå’ŒåŠ å…¥æµç¨‹
```mermaid
flowchart TD
    A["æ¸¸æˆå¤§å…<br/>ç©å®¶é€‰æ‹©"] --> B{é€‰æ‹©ä»€ä¹ˆ?}
    
    B -->|åˆ›å»ºæˆ¿é—´| C["è¾“å…¥æˆ¿é—´åç§°"]
    B -->|åŠ å…¥åŒ¹é…| D["åŠ å…¥åŒ¹é…é˜Ÿåˆ—"]
    
    C --> E{æ˜¯å¦è®¾ç½®<br/>å¯†ç ?}
    E -->|è®¾ç½®å¯†ç | F["isPrivate=true"]
    E -->|ä¸è®¾ç½®| G["isPrivate=false"]
    
    F --> H["emit: lobby:create-room<br/>{gameId, roomName,<br/>isPrivate, password}"]
    G --> H
    
    H --> I["åç«¯åˆ›å»º Room"]
    I --> J["æˆ¿ä¸»è‡ªåŠ¨åŠ å…¥"]
    J --> K["emit: room:created"]
    
    K --> L["è¿›å…¥æˆ¿é—´é¡µé¢"]
    L --> M["æ˜¾ç¤ºæˆ¿é—´å†…ç©å®¶åˆ—è¡¨"]
    M --> N["ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥"]
    
    D --> O["emit: matching:join-queue<br/>{gameId, mode}"]
    O --> P["æœåŠ¡å™¨ä¿å­˜åˆ°<br/>åŒ¹é…é˜Ÿåˆ—"]
    P --> Q["ç­‰å¾…åŒ¹é…æˆåŠŸ"]
    Q --> R["ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæˆ¿é—´<br/>åŒ¹é…æˆåŠŸçš„ç©å®¶"]
    R --> L
    
    style H fill:#bbdefb,color:#000
    style I fill:#fff9c4,color:#000
    style L fill:#c8e6c9,color:#000
```

### æˆ¿é—´å†…æµç¨‹
```mermaid
flowchart TD
    A["æˆ¿é—´ç­‰å¾…çŠ¶æ€<br/>status=waiting"] --> B["æˆ¿é—´å†…ç©å®¶åˆ—è¡¨"]
    
    B --> C{æˆ¿ä¸»æ“ä½œ}
    C -->|å¼€å§‹æ¸¸æˆ| D["emit: room:start-game"]
    C -->|è¸¢å‡ºç©å®¶| E["emit: room:kick-player<br/>{targetPlayerId}"]
    
    D --> F["æ£€æŸ¥äººæ•°â‰¥minPlayers"]
    F -->|äººæ•°ä¸è¶³| G["æç¤ºå¤±è´¥"]
    F -->|äººæ•°è¶³å¤Ÿ| H["RoomçŠ¶æ€æ”¹ä¸º<br/>status=loading"]
    
    H --> I["å¹¿æ’­ç»™æˆ¿é—´æ‰€æœ‰ç©å®¶<br/>emit: room:game-started"]
    
    I --> J["æ¸¸æˆå¼€å§‹<br/>status=playing"]
    
    J --> K["ç©å®¶åˆ†ä¸ºä¸¤ç±»"]
    K --> L["æ¸¸æˆç©å®¶<br/>type=player<br/>å‚ä¸æ¸¸æˆ"]
    K --> M["è§‚çœ‹ç©å®¶<br/>type=spectator<br/>è§‚çœ‹æ¸¸æˆ"]
    
    L --> N["æ¸¸æˆè¿›è¡Œä¸­<br/>å¯ä»¥æ“ä½œ"]
    M --> O["æ¸¸æˆè¿›è¡Œä¸­<br/>åªèƒ½è§‚çœ‹"]
    
    N --> P{æˆ¿é—´å†…ç©å®¶æ“ä½œ}
    O --> P
    
    P -->|æˆ¿ä¸»ç¦»å¼€| Q["è½¬ç§»æˆ¿ä¸»<br/>æˆ–è§£æ•£æˆ¿é—´"]
    P -->|æ™®é€šç©å®¶ç¦»å¼€| R["ç¦»å¼€æˆ¿é—´<br/>statusæ”¹ä¸ºspectator"]
    P -->|æˆ¿ä¸»è¸¢äºº| S["è¢«è¸¢ç©å®¶<br/>å¼ºåˆ¶ç¦»å¼€"]
    P -->|æ¸¸æˆç»“æŸ| T["emit: room:game-finished"]
    
    style A fill:#e1bee7,color:#000
    style J fill:#ffccbc,color:#000
    style L fill:#a5d6a7,color:#000
    style M fill:#90caf9,color:#000
```

### æ¸¸æˆç»“æŸæµç¨‹
```mermaid
flowchart TD
    A["æ¸¸æˆç»“æŸ<br/>status=finished"] --> B["ç»Ÿè®¡æ¸¸æˆç»“æœ"]
    
    B --> C["ç¡®å®šèƒœè€…å’Œè´¥è€…"]
    
    C --> D["å¯¹æ¯ä¸ªæ¸¸æˆç©å®¶<br/>type=player"]
    
    D --> E{ç©å®¶<br/>èƒœåˆ©?}
    
    E -->|èƒœåˆ©| F["æ›´æ–°ç»Ÿè®¡æ•°æ®<br/>âœ“ wins ++<br/>âœ“ total_games ++<br/>âœ“ rating += 25<br/>âœ“ exp += 100"]
    
    E -->|å¤±è´¥| G["æ›´æ–°ç»Ÿè®¡æ•°æ®<br/>âœ“ losses ++<br/>âœ“ total_games ++<br/>âœ“ rating -= 10<br/>âœ“ exp += 50"]
    
    F --> H["emit: player:stats-updated<br/>è¿”å›æ–°çš„ç­‰çº§ç»éªŒåˆ†æ•°"]
    G --> H
    
    H --> I["å‰ç«¯åˆ·æ–°<br/>æ˜¾ç¤ºæ›´æ–°åçš„æ•°æ®"]
    
    I --> J["æ’­æ”¾ç»“æœåŠ¨ç”»"]
    J --> K["æç¤ºè¿”å›å¤§å…"]
    K --> L["navigateTo('lobby')"]
    
    L --> M["æ¸¸æˆè®°å½•ä¿å­˜åˆ°<br/>MongoDB game_records"]
    
    style A fill:#ffccbc,color:#000
    style F fill:#a5d6a7,color:#000
    style G fill:#ffcdd2,color:#000
    style M fill:#c8e6c9,color:#000
```